#+TITLE: System Identity & Environment
#+PROPERTY: header-args:emacs-lisp :tangle ~/.config/doom/lisp/00-system.el

* Auto-tangle literate Org config files
#+begin_src emacs-lisp
(defvar dps/sys-literate-dir (expand-file-name "literate/" "~/.config/doom/")
  "Directory containing literate Org configuration files to auto-tangle.")

(defun dps/sys-org-in-literate-dir-p (file)
  "Return non-nil if FILE resides under dps/sys-literate-dir."
  (when (and file dps/sys-literate-dir)
    (string-prefix-p (file-truename dps/sys-literate-dir)
      (file-truename (file-name-directory file)))))

(defun dps/sys-auto-tangle-on-save ()
  "Auto-tangle this Org file if it is inside dps/sys-literate-dir."
  (when (and (eq major-mode 'org-mode)
          buffer-file-name
          (dps/sys-org-in-literate-dir-p buffer-file-name))
    (let ((org-confirm-babel-evaluate nil))
      (org-babel-tangle))))

(add-hook 'after-save-hook #'dps/sys-auto-tangle-on-save)
#+end_src
* Theme
#+begin_src emacs-lisp
(setq doom-theme 'doom-snazzy
  doom-font (font-spec :family "Iosevka Extended" :size 18)
  doom-variable-pitch-font (font-spec :family "Iosevka Extended")
  doom-symbol-font (font-spec :family "Symbola")
  doom-big-font (font-spec :family "Iosevka Extended" :size 40))

(custom-theme-set-faces! 'doom-snazzy
  '(org-level-1 :inherit outline-1 :height 1.35)
  '(org-level-2 :inherit outline-2 :height 1.25)
  '(org-level-3 :inherit outline-3 :height 1.18)
  '(org-level-4 :inherit outline-4 :height 1.12)
  '(org-document-title :height 1.45 :bold t))
#+end_src
* Visuals
#+begin_src emacs-lisp
(setq display-line-numbers-type 'relative
  fill-column 80
  display-fill-column-indicator-column 80
  undo-limit 80000000
  evil-want-fine-undo t
  confirm-kill-emacs nil)

(global-visual-line-mode 1)
(global-subword-mode 1)
(add-hook 'prog-mode-hook #'display-fill-column-indicator-mode)
(add-hook 'text-mode-hook #'display-fill-column-indicator-mode)
(display-time-mode 1)
#+end_src
* Window Split
#+begin_src emacs-lisp
(setq evil-split-window-below t
  evil-vsplit-window-right t)
(add-to-list 'default-frame-alist '(height . 24))
(add-to-list 'default-frame-alist '(width . 90))

(defadvice! dps/sys-consult-after-split (&rest _)
  :after '(evil-window-split evil-window-vsplit)
  (consult-buffer))
#+end_src
* Defaults, Safety, and Paths
#+begin_src emacs-lisp
(defconst my-org-path (file-truename "~/ssd/documents/org/"))
(defconst my-org-roam (file-truename "~/ssd/documents/org/roam"))
(defconst my-org-dail (file-truename "~/ssd/documents/org/roam/daily/"))

(setq org-directory my-org-path
      org-roam-directory my-org-roam
      org-roam-dailies-directory my-org-dail
  password-cache-expiry 10)

(after! org-roam
  (unless (file-exists-p org-roam-directory)
    (make-directory org-roam-directory t)))

(setq deft-directory my-org-path
  deft-extensions (list "org")
  deft-recursive t)

(setq gc-cons-threshold 100000000) ; 100MB
(setq read-process-output-max (* 1024 1024)) ; 1MB
(setq lsp-idle-delay 0.5)
(setq lsp-log-io nil) ; Disable LSP logging for speed

(setq-default window-combination-resize t
  x-stretch-cursor t)
#+end_src
* Org-Roam UI Improvements
#+begin_src emacs-lisp
(after! org-roam
    (setq org-roam-buffer-position 'right)
    (setq org-roam-buffer-width 0.3))

(setq org-roam-node-display-template
    (concat "${title:*} "
        (propertize "${tags:20}" 'face 'org-tag)))
#+end_src
* Org-Crypt
#+begin_src emacs-lisp
(after! org
  (require 'org-crypt)
  ;; Encrypt all entries tagged with "crypt"
  (org-crypt-use-before-save-magic)
  ;; Prevent the "crypt" tag from being inherited by sub-headings
  (setq org-tags-exclude-from-inheritance '("crypt"))
  ;; Set to nil to use symmetric encryption (password-based)
  ;; This is best for syncing with mobile devices like Android/iOS
  (setq org-crypt-key nil)
  ;; CRITICAL: Disable auto-save for buffers with encrypted text to prevent leaks
  (setq auto-save-default nil))
#+end_src
* Navigate the Document
#+begin_src emacs-lisp
(defun dps/write-goto-src-begin ()
  "Jump to the beginning of the source block at point."
  (interactive)
  (let ((el (org-element-at-point)))
    (when (eq (org-element-type el) 'src-block)
      (goto-char (org-element-property :begin el)))))

(defun dps/write-goto-src-end ()
  "Jump to the end of the source block at point."
  (interactive)
  (let ((el (org-element-at-point)))
    (when (eq (org-element-type el) 'src-block)
      (goto-char (org-element-property :end el))
      (forward-line -1))))
#+end_src
* Modeline
#+begin_src emacs-lisp
(after! doom-modeline
  (setq doom-modeline-height 40
    doom-modeline-bar-width 10
    doom-modeline-buffer-file-name-style 'file-name-with-project
    doom-modeline-major-mode-icon t
    doom-modeline-vcs-max-length 50
    ))
#+end_src
* Sync Org Directory
#+begin_src emacs-lisp
(defun dps/org-sync ()
    "Quick sync: stage all, commit with timestamp, push."
    (interactive)
    (let ((default-directory org-directory))
        (shell-command "git add -A")
        (shell-command (format "git commit -m 'sync: %s'" (format-time-string "%Y-%m-%d %H:%M")))
        (shell-command "git push"))
    (message "Org files synced!"))
#+end_src
